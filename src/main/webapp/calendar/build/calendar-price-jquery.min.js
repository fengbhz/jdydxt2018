/* calendar-pirce-jquery | version: 1.0.2 | author: Capricorncd | 2017-06-25 */
"use strict";!function($){function CalendarPrice(a){a.el||a.error&&a.error({code:1,msg:"请配置日历显示的容器!"}),this.opts=$.extend({},CalendarPrice.DEFAULTS,a),this.createStyleCode(),this.startDate=this._getStartDate(),this.endDate=this._getEndDate(),this.data=this._getOptionsData(),this.month=this._formatThisMonth(this.opts.month),this.Initialization(),this.setupDayDetailWindow()}function formatDate(a,b){/(y+)/i.test(b)&&(b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));var c={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds()};for(var d in c)if(new RegExp("("+d+")").test(b)){var e=c[d]+"";b=b.replace(RegExp.$1,1===RegExp.$1.length?e:formatNumber(e))}return b}function formatNumber(a){return a=a.toString(),a[1]?a:"0"+a}function toNumber(a){return a=parseInt(a),isNaN(a)?0:a}var TODAY=new Date,today=formatDate(TODAY,"yyyy-MM-dd"),ONE_DAY_MSEC=864e5,tomorrow=formatDate(new Date(Date.parse(TODAY)+ONE_DAY_MSEC),"yyyy-MM-dd"),fn=CalendarPrice.prototype;CalendarPrice.DEFAULTS={data:[],month:formatDate(TODAY,"yyyy/MM"),startDate:formatDate(TODAY,"yyyy/MM/dd"),endDate:null,cancel:null,callback:null,error:null,hideFooterButton:!1,style:{bgColor:"#fff"}},fn._formatThisMonth=function(a){var b=null;return b=/^(\d{4})[-\.\/](\d{1,2})/.test(a)?this.dateToObject(RegExp.$1+"/"+RegExp.$2):this.dateToObject(formatDate(TODAY,"yyyy/MM")),b<=this.endDate&&b>=this.startDate?b:this.dateToObject(formatDate(this.startDate,"yyyy/MM"))},fn.Initialization=function(){this.createCalendar();var a=this;$(this.opts.el).on("click",".prev-month",function(){a._prevMonth()}),$(this.opts.el).on("click",".next-month",function(){a._nextMonth()}),this.setupPriceAndStock(),$(this.opts.el).on("click",".btn-reset",function(){a.data=a._getOptionsData(),a.createCalendar(),console.log("reset completed!")}),$(this.opts.el).on("click",".btn-confirm",function(){a.opts.callback&&a.opts.callback(a.data)}),$(this.opts.el).on("click",".btn-cancel",function(){a.opts.cancel&&a.opts.cancel()})},fn._prevMonth=function(){var a=toNumber(formatDate(this.month,"yyyy")),b=toNumber(formatDate(this.month,"MM"));this.month=1===b?this.dateToObject(a-1+"/12"):this.dateToObject(a+"/"+(b-1)),this.createCalendar()},fn._nextMonth=function(){var a=toNumber(formatDate(this.month,"yyyy")),b=toNumber(formatDate(this.month,"MM"));this.month=12===b?this.dateToObject(a+1+"/01"):this.dateToObject(a+"/"+(b+1)),this.createCalendar()},fn._getStartDate=function(){var a=this.dateToObject(this.opts.startDate);return a&&a>=TODAY?a:TODAY},fn._getEndDate=function(){var a=this.opts.endDate,b=null,c=null,d=null;return/^(\d{4})[-\.\/](\d{1,2})/.test(a)&&(b=RegExp.$1,c=toNumber(RegExp.$2)),b&&c||(b=toNumber(formatDate(TODAY,"yyyy"))+1,c=toNumber(formatDate(TODAY,"MM"))),d=/^\d{4}[-\.\/]\d{1,2}[-\.\/](\d{1,2})/.test(a)?RegExp.$1:new Date(Date.parse(new Date(b,c))-ONE_DAY_MSEC).getDate(),this.dateToObject(b+"/"+c+"/"+d)},fn.dateToObject=function(a){var b="";return/(\d{4})[-\/\.](\d{1,2})[-\/\.]?/.test(a)&&(b+=RegExp.$1+"/"+RegExp.$2),/[-\/\.]\d{1,2}[-\/\.](\d{1,2})/.test(a)?b+="/"+RegExp.$1:b+="/01",/\d{4}\/\d{1,2}\/\d{1,2}/.test(b)?new Date(b):(this.opts.error&&this.opts.error({code:1,msg:a+": 日期格式不合法!"}),!1)},fn.createCalendar=function(){var a=!0,b=!0,c=formatDate(this.month,"yyyyMM");formatDate(this.startDate,"yyyyMM")>=c&&(a=!1),formatDate(this.endDate,"yyyyMM")<=c&&(b=!1);var d="";d+='<div class="capricorncd-calendar-container">',d+='\t<div class="calendar-head-wrapper">',a&&(d+='       <a class="prev-month" title="上一月"></a>'),d+='\t\t<div class="calendar-month-title">'+formatDate(this.month,"yyyy年MM月")+"</div>",b&&(d+='       <a class="next-month" title="下一月"></a>'),d+="\t</div>",d+='\t<div class="calendar-table-wrapper">',d+='  \t    <table cellpadding="4" cellspacing="0">',d+='\t\t    <thead><tr class="week"><th class="weekend">日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th class="weekend">六</th></tr></thead>',d+="\t\t    <tbody>"+this._createTbody()+"</tbody>",d+="\t    </table>",d+="    </div>",this.opts.hideFooterButton||(d+='    <div class="calendar-foot-wrapper">',d+='        <button class="btn btn-reset">重置</button>',d+='        <button class="btn btn-confirm">确定</button>',d+='        <button class="btn btn-cancel">取消</button>',d+="    </div>"),d+="</div>",$(this.opts.el).html(d),this.renderDataToTalbe()},fn._createTbody=function(){for(var a=this._getMonthDays(),b=this.month.getDay(),c=0,d=Math.ceil((a+b)/7),e="",f="",g=0;g<d;g++){f+="<tr>";for(var h=1;h<=7;h++)c=7*g+h-b,c>0&&c<=a?(e=formatDate(this.month,"yyyy-MM-")+formatNumber(c),today==e&&(c="今天"),tomorrow==e&&(c="明天"),e>=formatDate(this.startDate,"yyyy-MM-dd")?f+='<td class="valid-hook" data-week="'+(h-1)+'" data-id="'+e+'"><b>'+c+'</b><div class="data-hook"></div></td>':f+='<td class="disabled"><b>'+c+"</b></td>"):f+="<td>&nbsp;</td>";f+="</tr>"}return f},fn.renderDataToTalbe=function(){var a=this,b=$(this.opts.el).find(".valid-hook"),c=null;b.each(function(){c=a._getDateData($(this).data("id"));var b=a.dayComplate().toString();if(c){for(var d in c)b=b.replace("{"+d+"}",c[d]);$(this).data("data",JSON.stringify(c)).find(".data-hook").html(b)}else $(this).data("data","{}")})},fn._getDateData=function(a){for(var b=this.data,c=0;c<b.length;c++)if(a==b[c].date)return b[c];return null},fn._getMonthDays=function(){var a=this.month,b=formatDate(a,"yyyy"),c=formatDate(a,"MM");return 12==c?31:new Date(Date.parse(new Date(b,c,1))-ONE_DAY_MSEC).getDate()},fn.setupDayDetailWindow=function(){var a="";a+='<div class="cddsw-container">',a+='   <div class="cddsw-head-wrapper">',a+='       <div class="cddsw-title">0000-00-00</div>',a+='       <a class="cddsw-close"><i></i></a>',a+="   </div>",a+='   <ul class="cddsw-form-wrapper clearfix">',a+=this._createDaySetupInputGroup(),a+="   </ul>",a+='   <fieldset class="cddsw-batch-settings clearfix">',a+='       <legend class="bs-title"><b>批量设置</b></legend>',a+='       <div class="bs-content">',a+='           <lable class="bs-lable">日期范围</lable>',a+='           <div class="bs-options-wrapper">',a+='               <input class="itext" name="startDay" type="text">',a+='               <span class="white-space">-</span>',a+='               <input class="itext" name="endDay" type="text">',a+='               <label class="drw-enable"><input name="enableDateRange" type="checkbox"> 启用</label>',a+="           </div>",a+="       </div>",a+='       <div class="bs-content bs-week-chekbox">',a+='           <lable class="bs-lable">设置星期</lable>',a+='           <div class="bs-options-wrapper">',a+='               <label><input name="setWeek" type="checkbox" value="1"> 周一</label>',a+='               <label><input name="setWeek" type="checkbox" value="2"> 周二</label>',a+='               <label><input name="setWeek" type="checkbox" value="3"> 周三</label>',a+='               <label><input name="setWeek" type="checkbox" value="4"> 周四</label>',a+='               <label><input name="setWeek" type="checkbox" value="5"> 周五</label>',a+='               <label><input name="setWeek" type="checkbox" value="6"> 周六</label>',a+='               <label><input name="setWeek" type="checkbox" value="0"> 周日</label>',a+="           </div>",a+="       </div>",a+="   </fieldset>",a+='   <div class="cddsw-foot-wrapper">',a+='       <button class="btn-confirm">启用本设置</button>',a+='       <button class="btn-cancel">取消</button>',a+="   </div>",a+="</div>",$("body").append('<div class="capricorncd-date-detailed-settings" style="display: none">'+a+"</div>")},fn._createDaySetupInputGroup=function(){for(var a="",b=this.opts.config,c=0;c<b.length;c++){var d=b[c];a+="<li>",a+="   <label>"+d.name+"</label>",a+='   <input name="'+d.key+'" type="text">',a+="</li>"}return a},fn.dayComplate=function(){var a=this.opts.show,b="";if(a&&a instanceof Array)for(var c=0;c<a.length;c++){var d=a[c];b+="<p>"+d.name+"{"+d.key+"}</p>"}return b},fn.setupPriceAndStock=function(){var a=this;$(this.opts.el).on("click",".valid-hook",function(){var b=$(this).data("id"),c=$(this).data("data");try{c=JSON.parse(c)}catch(a){c={}}if(a.opts.everyday)return void a.opts.everyday(c);var d=$(".capricorncd-date-detailed-settings");d.find('.cddsw-form-wrapper [type="text"]').val(""),d.find('[name="enableDateRange"]').prop("checked",!1),d.find('[name="setWeek"]').prop("checked",!1),$.each(c,function(a,b){d.find('[name="'+a+'"]').val(b)}),d.find(".cddsw-title").html(b),d.find('[name="startDay"], [name="endDay"]').val(b),d.show()}),$("body").on("click",".capricorncd-date-detailed-settings .cddsw-close, .capricorncd-date-detailed-settings .btn-cancel",function(){$(this).closest(".capricorncd-date-detailed-settings").hide()}),$("body").on("click",".capricorncd-date-detailed-settings .btn-confirm",function(){var b=$(this).closest(".cddsw-container"),c=b.find(".cddsw-title").text(),d={};b.find(".cddsw-form-wrapper [name]").each(function(){var a=$(this).attr("name"),b=$(this).val();d[a]=b}),d.date=c;var e=$(".cddsw-batch-settings"),f=e.find('[name="startDay"]').val(),g=e.find('[name="endDay"]').val(),h=e.find('[name="enableDateRange"]').prop("checked"),i=e.find('[name="setWeek"]:checked'),j=[];i.each(function(){j.push($(this).val())});var k=[];if(h){var l=a.handleSetDateRangeData(f,g);if(!l)return;if(k=l,0===j.length)return void a.handleThisData(d,k)}else{if(0===j.length)return void a.handleThisData(d);k=a.handleSetDateRangeData(formatDate(a.startDate,"yyyy-MM-dd"),formatDate(a.endDate,"yyyy-MM-dd"))}a.handleSetWeekData(j,k,function(b){b.data.length>0?a.handleThisData(d,b.data):a.opts.error&&a.opts.error({code:1,msg:"设置的日期范围或初始化的日期范围，与设置的周"+j.join(",")+"没有交集"})})})},fn.handleSetDateRangeData=function(a,b){function c(a){return!!/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})/.test(a)&&RegExp.$1+"/"+formatNumber(RegExp.$2)+"/"+formatNumber(RegExp.$3)}var d=this,e=[],f=c(a),g=c(b);return f?f<today?(this.opts.error&&this.opts.error({code:1,msg:"开始日期不能小于今天"}),!1):g?g<f?(this.opts.error&&this.opts.error({code:1,msg:"结束日期不能小于开始日期"}),!1):(f==g?e.push(formatDate(this.dateToObject(f),"yyyy-MM-dd")):e=function(a,b){for(var c=[],e=Date.parse(d.dateToObject(a)),f=Date.parse(d.dateToObject(b)),g=Math.floor((f-e)/ONE_DAY_MSEC)+1,h=0;h<g;h++){var i=new Date(e+ONE_DAY_MSEC*h);c.push(formatDate(i,"yyyy-MM-dd"))}return c}(f,g),e):(this.opts.error&&this.opts.error({code:1,msg:"结束日期格式错误"}),!1):(this.opts.error&&this.opts.error({code:1,msg:"开始日期格式错误"}),!1)},fn.handleSetWeekData=function(a,b,c){var d=this,e=a.join(","),f=[];$.each(b,function(a,b){var c=d.dateToObject(b).getDay();e.indexOf(c)>-1&&f.push(b)}),c&&c({code:0,msg:"completed",data:f})},fn.handleThisData=function(a,b){var c=b||[],d=c.length;if(0===d)this._updateThisData(a);else for(var e=0;e<d;e++)this._updateThisData(a,c[e]);this.data=this.sort(this.rmRepeat(this.data,"date")),this.renderDataToTalbe(),$(".capricorncd-date-detailed-settings").hide()},fn._updateThisData=function(a,b){var c=this,d=!1,e={};e.date=b||a.date,$.each(a,function(a,b){"date"!=a&&(e[a]=b)}),$.each(this.data,function(a,b){if(e.date===b.date)return d=!0,c.data[a]=e,!1}),d||this.data.push(e)},fn._getOptionsData=function(){var a=formatDate(this.startDate,"yyyy-MM-dd"),b=[],c=this.opts.data;if(c&&c instanceof Array)for(var d=0;d<c.length;d++)c[d].date>=a&&b.push(c[d]);return this.sort(this.rmRepeat(b,"date"))},fn.createStyleCode=function(){var style=this.opts.style||{},count=0;for(var key in style)if(++count>0)break;if(count){var defaultStyle={headerBgColor:"#098cc2",headerTextColor:"#fff",weekBgColor:"#098cc2",weekTextColor:"#fff",weekendBgColor:"#098cc2",weekendTextColor:"#fff",validDateTextColor:"#333",validDateBgColor:"#fff",validDateBorderColor:"#eee",validDateHoverBgColor:"#098cc2",validDateHoverTextColor:"#fff",invalidDateTextColor:"#ccc",invalidDateBgColor:"#fff",invalidDateBorderColor:"#eee",footerBgColor:"#fff",resetBtnBgColor:"#77c351",resetBtnTextColor:"#fff",resetBtnHoverBgColor:"#55b526",resetBtnHoverTextColor:"#fff",confirmBtnBgColor:"#098cc2",confirmBtnTextColor:"#fff",confirmBtnHoverBgColor:"#00649a",confirmBtnHoverTextColor:"#fff",cancelBtnBgColor:"#fff",cancelBtnBorderColor:"#bbb",cancelBtnTextColor:"#999",cancelBtnHoverBgColor:"#fff",cancelBtnHoverBorderColor:"#bbb",cancelBtnHoverTextColor:"#666"},concatStyle=$.extend({},defaultStyle,this.opts.style),templateStyle=".capricorncd-calendar-container .calendar-head-wrapper, .capricorncd-date-detailed-settings .cddsw-container .cddsw-head-wrapper{background-color: {headerBgColor}}.capricorncd-calendar-container .calendar-head-wrapper .calendar-month-title, .capricorncd-date-detailed-settings .cddsw-container .cddsw-head-wrapper .cddsw-title{color: {headerTextColor};}.capricorncd-calendar-container .calendar-table-wrapper table .week{background-color:{weekBgColor};color:{weekTextColor}};.capricorncd-calendar-container .calendar-table-wrapper table .week th.weekend{background-color:{weekendBgColor};color:{weekendTextColor}}.capricorncd-calendar-container .calendar-table-wrapper table td{color:{validDateTextColor};background-color:{validDateBgColor};border-bottom: 1px solid {validDateBorderColor};border-right: 1px solid {validDateBorderColor};}.capricorncd-calendar-container .calendar-table-wrapper table td.valid-hook:hover{background-color:{validDateHoverBgColor};}.capricorncd-calendar-container .calendar-table-wrapper table td.valid-hook:hover b, .capricorncd-calendar-container .calendar-table-wrapper table td.valid-hook:hover p{color: {validDateHoverTextColor}}.capricorncd-calendar-container .calendar-table-wrapper table td.disabled{color:{invalidDateTextColor};background-color:{invalidDateBgColor}; border-bottom: 1px solid {invalidDateBorderColor};border-right: 1px solid {invalidDateBorderColor};}.capricorncd-calendar-container .calendar-foot-wrapper, .capricorncd-date-detailed-settings .cddsw-foot-wrapper{background-color:{footerBgColor}}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-reset{background-color: {resetBtnBgColor};border: 1px solid {resetBtnBgColor};color: {resetBtnTextColor}}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-reset:hover{background-color: {resetBtnHoverBgColor};border: 1px solid {resetBtnHoverBgColor};color: {resetBtnHoverTextColor}}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-confirm, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-confirm {background-color: {confirmBtnBgColor};border: 1px solid {confirmBtnBgColor};color: {confirmBtnTextColor}}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-confirm:hover, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-confirm:hover {background-color: {confirmBtnHoverBgColor};border: 1px solid {confirmBtnHoverBgColor};color: {confirmBtnHoverTextColor}}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-cancel, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-cancel {background-color: {cancelBtnBgColor};color:{cancelBtnTextColor};border: 1px solid {cancelBtnBorderColor};}.capricorncd-calendar-container .calendar-foot-wrapper button.btn-cancel:hover, .capricorncd-date-detailed-settings .cddsw-foot-wrapper button.btn-cancel:hover {background-color: {cancelBtnHoverBgColor};border-color: {cancelBtnHoverBorderColor};color: {cancelBtnHoverTextColor}}",reg=null;for(var key in concatStyle)reg=eval("/{"+key+"}/g"),templateStyle=templateStyle.replace(reg,concatStyle[key]);$("head").append("<style>"+templateStyle+"</style>")}},fn.sort=function(a){if(!(a instanceof Array))return this.opts.error&&this.opts.error({code:1,msg:"this.sort 传入的arr为非数组"}),a;if(a.length<1)return a;for(var b=0,c=null,d=0;d<a.length;d++){b=d;for(var e=d+1;e<a.length;e++)a[e].date<a[b].date&&(b=e,c=a[d],a.splice(d,1,a[e]),a.splice(e,1,c))}return a},fn.rmRepeat=function(a,b){for(var c={},d=[],e=0;e<a.length;e++){var f=a[e];if(b)try{f=a[e][b]}catch(a){}c[f]||(d.push(a[e]),c[f]=!0)}return d},$.extend({CalendarPrice:function(a){new CalendarPrice(a)}})}(jQuery);